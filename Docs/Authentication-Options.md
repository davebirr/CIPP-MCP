# CIPP-MCP Authentication Options for Copilot Studio

## üîê Authentication Methods Overview

When configuring your Custom Connector in Copilot Studio, you'll need to choose an authentication method. Here are the recommended approaches for different scenarios:

## 1. OAuth 2.0 (Recommended for Production)

### When to Use
- Production deployments
- Multi-user environments
- Enterprise security requirements
- Audit trail compliance

### Configuration
```json
{
  "authenticationType": "oauth2",
  "oauth2Settings": {
    "authorizationUrl": "https://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/authorize",
    "tokenUrl": "https://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/token",
    "scope": "https://graph.microsoft.com/.default"
  }
}
```

### Setup Steps
1. **Security** tab in Custom Connector
2. Select **OAuth 2.0**
3. Configure Azure AD integration:
   - **Identity Provider**: Azure Active Directory
   - **Client ID**: `{your-app-registration-client-id}` (from Azure Portal)
   - **Client Secret**: `{your-app-registration-secret}` (from Azure Portal)
   - **Authorization URL**: `https://login.microsoftonline.com/common/oauth2/v2.0/authorize`
   - **Token URL**: `https://login.microsoftonline.com/common/oauth2/v2.0/token`
   - **Resource URL**: `https://graph.microsoft.com/` (or leave empty)
   - **Scope**: `https://graph.microsoft.com/.default` (or `openid profile`)
   - **Redirect URL**: Auto-generated by Power Platform
   - **Enable on-behalf-of login**: `false`

### Benefits
- ‚úÖ Secure token-based authentication
- ‚úÖ Automatic token refresh
- ‚úÖ User identity tracking
- ‚úÖ Enterprise compliance
- ‚úÖ Audit trail capability

## 2. No Authentication (Testing Only)

### When to Use
- Development and testing
- Proof of concept deployments
- Internal lab environments
- Quick prototyping

### Configuration
```json
{
  "authenticationType": "none"
}
```

### Setup Steps
1. **Security** tab in Custom Connector
2. Select **No Authentication**
3. CIPP-MCP server handles authentication internally via Azure Key Vault

### Benefits
- ‚úÖ Quick setup for testing
- ‚úÖ No additional Azure AD configuration
- ‚úÖ Simplified development workflow

### Limitations
- ‚ùå No user identity tracking
- ‚ùå Limited audit capabilities
- ‚ùå Not suitable for production

## 3. API Key (Alternative Option)

### When to Use
- Simple production setups
- Single-user scenarios
- Specific security requirements

### Configuration
```json
{
  "authenticationType": "apiKey",
  "apiKeySettings": {
    "keyLocation": "header",
    "keyName": "X-API-Key"
  }
}
```

### Setup Steps
1. **Security** tab in Custom Connector
2. Select **API Key**
3. Configure:
   - **Parameter Name**: `X-API-Key`
   - **Parameter Location**: Header
   - **Key Value**: Your CIPP-MCP API key

### Benefits
- ‚úÖ Simple token-based security
- ‚úÖ Easy to implement
- ‚úÖ Consistent authentication

### Limitations
- ‚ùå Manual key management
- ‚ùå No automatic rotation
- ‚ùå Shared key across users

## ÔøΩ Specific Configuration for roanoketechhub.com

### For Your CIPP-MCP Deployment
Based on your deployment at `cipp-mcp.roanoketechhub.com` and email `davidb@roanoketechhub.com`:

#### OAuth 2.0 Form Values:
```
Identity Provider: Azure Active Directory
‚òê Enable Service Principal support (leave unchecked)

Client ID: [NEED TO CREATE - see steps below]
Client secret: [NEED TO CREATE - see steps below]

Authorization URL: https://login.microsoftonline.com/common/oauth2/v2.0/authorize
Tenant ID: common
Resource URL: https://graph.microsoft.com/
Enable on-behalf-of login: false
Scope: openid profile https://graph.microsoft.com/.default

Redirect URL: [Auto-generated after saving - copy this for App Registration]
```

#### Step-by-Step App Registration Setup:
1. **Go to Azure Portal** ‚Üí **Azure Active Directory** ‚Üí **App registrations**
2. **New registration**:
   - **Name**: `CIPP-MCP-Connector`
   - **Supported account types**: Accounts in this organizational directory only (roanoketechhub.com)
   - **Redirect URI**: Leave blank for now (will add after connector generates it)
3. **After creation, note the Application (client) ID** ‚Üí This is your **Client ID**
4. **Certificates & secrets** ‚Üí **New client secret**:
   - **Description**: `CIPP-MCP-Connector-Secret`
   - **Expires**: 24 months (recommended)
   - **Copy the secret value** ‚Üí This is your **Client secret**
5. **API permissions** ‚Üí **Add a permission**:
   - **Microsoft Graph** ‚Üí **Delegated permissions**
   - Add: `openid`, `profile`, `User.Read`
   - **Grant admin consent** for roanoketechhub.com
6. **Authentication** ‚Üí **Add platform** ‚Üí **Web**:
   - **Redirect URI**: Use the auto-generated URL from Custom Connector (step 7)
7. **Save Custom Connector** to generate Redirect URL, then add it to App Registration

#### Testing Values:
- **Test User**: `davidb@roanoketechhub.com`
- **Expected Behavior**: Should authenticate and allow MCP tool calls
- **Verification**: Tools should work since you already have CIPP access

## üîß Alternative: No Authentication for Quick Testing

‚≠ê **RECOMMENDED FOR INITIAL TESTING** ‚≠ê

If you want to test immediately without OAuth setup:

#### Form Values for No Authentication:
```
Authentication Type: No authentication
```

**Why this works for your setup:**
- ‚úÖ Your CIPP-MCP server already handles authentication via Azure Key Vault
- ‚úÖ Your `davidb@roanoketechhub.com` account has CIPP access  
- ‚úÖ The MCP server uses managed identity to access CIPP-API
- ‚úÖ No additional connector-level authentication needed for testing
- ‚úÖ Immediate testing without App Registration setup

**Perfect for:**
- Initial functionality testing
- Verifying MCP tools work correctly
- Validating agent responses
- Confirming Custom Connector setup

**Next Steps After Testing:**
1. Verify all MCP tools respond correctly
2. Test a few sample queries through your Copilot Studio agent
3. Once confirmed working, optionally add OAuth 2.0 for production security

### üìã Generated Swagger Document
When you complete the Custom Connector setup, Copilot Studio generates a Swagger document that should look like this:

```yaml
swagger: '2.0'
info:
  title: CIPP MCP Server
  description: >-
    This MCP Server will work with Streamable HTTP and is meant to work with
    Microsoft Copilot Studio
  version: 1.0.0
host: cipp-mcp.roanoketechhub.com
basePath: /mcp
schemes:
  - https
consumes: []
produces: []
paths:
  /:
    post:
      summary: CIPP-MCP Streamable HTTP
      x-ms-agentic-protocol: mcp-streamable-1.0
      operationId: InvokeMCP
      responses:
        '200':
          description: Success
definitions: {}
parameters: {}
responses: {}
securityDefinitions: {}
security: []
tags: []
```

**Key Elements to Verify:**
- ‚úÖ `host: cipp-mcp.roanoketechhub.com` (your deployment URL)
- ‚úÖ `basePath: /mcp` (correct MCP endpoint)
- ‚úÖ `x-ms-agentic-protocol: mcp-streamable-1.0` (MCP protocol identifier)
- ‚úÖ `security: []` (no authentication, as configured)

## üèÜ Recommended Approach

### For Your Setup
```markdown
1. **OAuth 2.0** for user authentication to Copilot Studio
2. **Azure Managed Identity** for CIPP-MCP to CIPP-API communication
3. **Azure Key Vault** for CIPP credentials storage
4. **Application Insights** for audit logging
```

### Development/Testing
```markdown
1. **No Authentication** for Custom Connector (quick setup)
2. **Development Mode** in CIPP-MCP server
3. **Mock data** for testing scenarios
4. **Local development** environment
```

## üîß Authentication Flow Diagram

```
[User] 
  ‚Üì (Entra ID + MFA)
[Copilot Studio Agent]
  ‚Üì (OAuth 2.0 or No Auth)
[Custom Connector]
  ‚Üì (HTTPS/JSON-RPC)
[CIPP-MCP Server]
  ‚Üì (Managed Identity)
[Azure Key Vault] ‚Üí [CIPP-API]
  ‚Üì (App Registration)
[Microsoft Graph API]
```

## üõ°Ô∏è Security Best Practices

### For OAuth 2.0 Setup
1. **Use separate App Registration** for CIPP-MCP connector
2. **Limit permissions** to minimum required scope
3. **Enable conditional access** policies
4. **Monitor authentication logs** in Azure AD
5. **Rotate secrets regularly** (90-day cycle recommended)

### For No Authentication Setup
1. **Restrict network access** to trusted sources only
2. **Use HTTPS enforcement** at Web App level
3. **Monitor Application Insights** for unusual patterns
4. **Implement rate limiting** to prevent abuse
5. **Regular security reviews** of access patterns

## üö® Common Authentication Issues

### Authentication Challenge (Azure AD Login Page)
If tools return HTML login pages instead of data:

**URGENT - This is your current issue!** Your Copilot Studio agent is getting Azure AD login HTML and hallucinating tenant names because CIPP's authentication tokens have expired.

**Root Cause**: CIPP-MCP server can authenticate to Key Vault, but CIPP itself needs its Microsoft Graph tokens refreshed
**Solution**: Refresh CIPP authentication through the main CIPP interface

#### üö® IMMEDIATE ACTION REQUIRED

**Step 1: Fix CIPP Authentication**
1. **Navigate to**: `https://cipp.roanoketechhub.com`
2. **Login** with your `davidb@roanoketechhub.com` account
3. **Go to Settings** ‚Üí **SAM Setup** or **Service Principal**
4. **Check the status** - you'll see authentication errors or expired tokens
5. **Re-authorize** the Microsoft Graph connection
6. **Grant admin consent** if prompted
7. **Verify** you can see your actual tenants (not hallucinated ones)

**Step 2: Test After CIPP Fix**
```bash
# Test the MCP server after CIPP authentication is fixed
curl -X POST https://cipp-mcp.roanoketechhub.com/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "method": "tools/call", "params": {"name": "list_tenants"}, "id": 1}'
```

**Expected Result**: Real tenant JSON data instead of HTML login page

**Step 3: Verify Copilot Studio Agent**
After CIPP authentication is working, your agent should show:
- ‚úÖ **Real tenant names** from your Microsoft 365 environment
- ‚úÖ **Actual tenant GUIDs** and domain names
- ‚ùå **No more hallucinated business names** like "Blue Ridge Innovations"

#### Diagnose Key Vault Access:
```bash
# Check if managed identity has Key Vault access
az keyvault show --name your-cipp-keyvault --query "properties.accessPolicies[?objectId=='your-managed-identity-object-id']"

# List current Key Vault access policies
az keyvault list-policy --name your-cipp-keyvault --query "properties.accessPolicies[].{ObjectId:objectId,DisplayName:displayName,Permissions:permissions.secrets}"
```

#### Fix Managed Identity Permissions:
```bash
# Get your managed identity details
az identity show --name cipp-mcp-kmw7b5mja3zvs-mi --resource-group rg-CIPP-EastUS2

# Grant Key Vault access to managed identity
az keyvault set-policy --name your-cipp-keyvault \
  --object-id YOUR_MANAGED_IDENTITY_OBJECT_ID \
  --secret-permissions get list
```

#### Verify Required CIPP Secrets Exist:
```bash
# Check if required secrets exist in Key Vault
az keyvault secret list --vault-name your-cipp-keyvault --query "[?name=='CIPP-APPLICATION-ID' || name=='CIPP-APPLICATION-SECRET' || name=='CIPP-REFRESH-TOKEN'].{Name:name,Enabled:attributes.enabled}"
```

#### Fix Environment Variables:
The MCP server needs to know which Key Vault to use:
```bash
# Verify Key Vault environment variables are set correctly
az webapp config appsettings list --name cipp-mcp-kmw7b5mja3zvs-app --resource-group rg-CIPP-EastUS2 \
  --query "[?name=='KEY_VAULT_NAME' || name=='KEY_VAULT_URL' || name=='AZURE_CLIENT_ID']"
```

#### Test Key Vault Access:
```bash
# Test if managed identity can access Key Vault
curl -H "Metadata: true" \
  "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net/"

# This should return an access token if managed identity is working
```

### Long-Running Operation Timeouts
If tools like `list_tenants` timeout in Copilot Studio with 499 errors:

**Root Cause**: Long CIPP-API responses exceeding Copilot Studio timeout limits
**Solution**: Optimize Azure App Service configuration and implement caching

#### Azure App Service Optimization:
```bash
# Increase App Service Plan tier for better performance
az appservice plan update --name ASP-rg-CIPP-EastUS2-9bb6 --resource-group rg-CIPP-EastUS2 --sku S1

# Configure connection timeout settings
az webapp config set --name cipp-mcp-kmw7b5mja3zvs-app --resource-group rg-CIPP-EastUS2 \
  --web-sockets-enabled true \
  --http20-enabled true
```

#### Environment Variable Tuning:
```bash
# Add timeout and performance settings
az webapp config appsettings set --name cipp-mcp-kmw7b5mja3zvs-app --resource-group rg-CIPP-EastUS2 \
  --settings \
    REQUEST_TIMEOUT="300" \
    CIPP_CACHE_TTL="300" \
    ENABLE_RESPONSE_CACHING="true" \
    MAX_CONCURRENT_REQUESTS="5"
```

#### Verify Improved Performance:
```bash
# Test response time after optimization
time curl -X POST https://cipp-mcp.roanoketechhub.com/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "method": "tools/call", "params": {"name": "list_tenants"}, "id": 1}'
```

**Expected Results After Optimization:**
- ‚úÖ `list_tenants` responses under 30 seconds
- ‚úÖ Cached responses for subsequent calls (under 5 seconds)
- ‚úÖ No more 499 timeout errors in Copilot Studio
- ‚úÖ Better overall performance for all MCP tools

### DNS Resolution Error (CIPP-API Connection)
If you see errors like `Name or service not known (cipp.roanoktetechhub.com:443)`:

**Root Cause**: Typo in Azure App Service environment variable for CIPP-API URL
**Solution**: Fix the `CIPP_API_BASE_URL` setting in Azure

#### Fix via Azure Portal:
1. Go to **Azure Portal** ‚Üí **App Services** ‚Üí **cipp-mcp**
2. **Configuration** ‚Üí **Application settings**
3. Find `CIPP_API_BASE_URL` setting
4. Update from: `https://cipp.roanoktetechhub.com` (wrong)
5. Update to: `https://cipp.roanoketechhub.com` (correct - note the 'e')
6. **Save** and **Restart** the app service

#### Fix via Azure CLI:
```bash
# Check current setting (will show the typo)
az webapp config appsettings list --name cipp-mcp --resource-group rg-cipp-mcp --query "[?name=='CIPP_API_BASE_URL']"

# Fix the typo
az webapp config appsettings set --name cipp-mcp --resource-group rg-cipp-mcp \
  --settings CIPP_API_BASE_URL="https://cipp.roanoketechhub.com"

# Restart the app service
az webapp restart --name cipp-mcp --resource-group rg-cipp-mcp
```

#### Verify Fix:
```bash
# Test the corrected URL
curl https://cipp.roanoketechhub.com/api/health

# Test MCP tools after restart
curl -X POST https://cipp-mcp.roanoketechhub.com/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "method": "list_tenants", "id": 1}'
```

### OAuth 2.0 Troubleshooting
```bash
# Test OAuth token acquisition
curl -X POST "https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials&client_id={client_id}&client_secret={secret}&scope=https://graph.microsoft.com/.default"

# Verify token validity
curl -H "Authorization: Bearer {token}" \
  "https://graph.microsoft.com/v1.0/me"
```

### No Authentication Troubleshooting
```bash
# Test direct MCP server connectivity
curl https://cipp-mcp.roanoketechhub.com/health

# Test MCP tool listing
curl -X POST https://cipp-mcp.roanoketechhub.com/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "method": "tools/list", "id": 1}'
```

## üìã Authentication Checklist

### Pre-Deployment
- [ ] Choose authentication method based on environment
- [ ] Configure Azure AD App Registration (if using OAuth 2.0)
- [ ] Set up managed identity for CIPP-MCP server
- [ ] Verify Key Vault access permissions
- [ ] Test authentication flow end-to-end

### Post-Deployment
- [ ] Validate Custom Connector authentication
- [ ] Test MCP tool calls through Copilot Studio
- [ ] Monitor authentication logs and errors
- [ ] Document authentication configuration
- [ ] Create backup authentication method (if applicable)

---

üí° **Quick Start**: For immediate testing, use **No Authentication**. For production, implement **OAuth 2.0** with proper Azure AD integration.
